name: "API Upgrade"

on:
  workflow_call:
    inputs:
      api:
        type: string
        description: "API to upgrade"
        required: false
      workspace:
        type: string
        description: "Workspace name of the API"
        required: false

permissions:
  pull-requests: write
  contents: write
  packages: read

jobs:
  main:
    name: Upgrade
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      API: ${{ inputs.api || 'api' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: Set up package.json path
        id: package
        run: |
          if [ ${{ inputs.workspace || inputs.api }} ]; then
            path=$(npm exec -w=@bastion-technologies/${{ inputs.workspace || inputs.api }} --call 'pwd')/package.json
          else
            path=$(pwd)/package.json
          fi

          echo "path=$path" >> "$GITHUB_OUTPUT"
      - name: Should upgrade
        id: should_upgrade
        run: |
          CURRENT_VERSION=$(cat ${{ steps.package.outputs.path }} | jq -r '.version')
          echo "Current version is $CURRENT_VERSION"

          TAG=${{ inputs.api && format('{0}-', inputs.api) || '' }}$CURRENT_VERSION

          git diff --exit-code --no-patch $TAG HEAD package-lock.json && isDiff=$? || isDiff=$?
          echo "isDiff=$isDiff" >> "$GITHUB_OUTPUT"
      - name: Run upgrade
        if: steps.should_upgrade.outputs.isDiff == 1
        id: upgrade
        run: |
          SCRIPT=${{ inputs.api && format('upgrade-api:{0}', inputs.api) || 'upgrade-api' }}
          echo "Running $SCRIPT"
          npm run $SCRIPT patch

          VERSION=$(cat ${{ steps.package.outputs.path }} | jq -r '.version')
          echo "Upgraded ${{ env.API }} to version $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  
      - name: Create pull request
        if: steps.should_upgrade.outputs.isDiff == 1
        uses: peter-evans/create-pull-request@v5
        with:
          commit-message: "chore: Upgrade ${{ env.API }} to ${{ steps.upgrade.outputs.version }}"
          title: "chore: Upgrade ${{ env.API }} to ${{ steps.upgrade.outputs.version }}"
          body: |
            Upgrade ${{ env.API }} to ${{ steps.upgrade.outputs.version }}
          branch: "upgrade-${{env.API}}-${{ steps.upgrade.outputs.version }}"
          base: "main"
